<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel - Minimal</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent1: linear-gradient(135deg,#6ee7b7 0%,#3b82f6 100%);
      --accent2: linear-gradient(135deg,#fbcfe8 0%,#f97316 100%);
      --glass: rgba(255,255,255,0.7);
      --radius:14px;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:#0f172a}
    .app{
      display:grid;
      grid-template-columns:280px 1fr;
      gap:26px;
      padding:28px;
      min-height:100vh;
    }

    /* SIDEBAR */
    .sidebar{
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
      border:1px solid rgba(15,23,42,0.04);
      display:flex;flex-direction:column;gap:18px;
      position: sticky;
      top: 28px;
      height: calc(100vh - 56px);
      overflow-y: auto;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:44px;height:44px;border-radius:10px;background:var(--accent1);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;
      box-shadow: 0 6px 16px rgba(59,130,246,0.18);
    }
    .panel-title{font-weight:700;font-size:18px;}
    .nav{display:flex;flex-direction:column;gap:8px}
    .nav button{
      text-align:left;padding:10px;border-radius:10px;border:1px solid transparent;background:transparent;font-weight:600;color:#0f172a;cursor:pointer;
      transition:all .18s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .nav button:hover{transform:translateX(6px); background: rgba(59,130,246,0.05);}
    .nav button.active{background:var(--glass);border-color:rgba(15,23,42,0.04);box-shadow:inset 0 0 0 1px rgba(0,0,0,0.02)}
    .mini-stat{display:flex;flex-direction:column;gap:8px}
    .stat-card{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(59,130,246,0.06),rgba(59,130,246,0.02));border:1px solid rgba(59,130,246,0.06)}
    .stat-card .n{font-weight:700;font-size:18px}
    .stat-card .l{font-size:12px;color:var(--muted)}

    /* MAIN */
    .main{
      display:flex;flex-direction:column;gap:18px;
    }
    header.top{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
    }
    .search{
      display:flex;gap:8px;align-items:center;background:var(--card);padding:10px;border-radius:12px;border:1px solid rgba(15,23,42,0.04);box-shadow:0 6px 18px rgba(2,6,23,0.03);
      flex: 1;
      max-width: 500px;
    }
    .search input{border:0;outline:0;background:transparent;font-size:14px;width:100%}

    /* content area */
    .card{
      background:var(--card);border-radius:var(--radius);padding:18px;border:1px solid rgba(15,23,42,0.04);box-shadow:0 10px 30px rgba(2,6,23,0.04)
    }
    h2{margin:0 0 12px 0}
    h3{margin:0 0 10px 0}
    .flex{display:flex;gap:12px;align-items:center}
    .grid{display:grid;gap:12px}

    /* lists and forms */
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(15,23,42,0.04);text-align:left}
    .btn{
      display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;
      background:linear-gradient(90deg,#06b6d4,#3b82f6);color:#fff;
      box-shadow:0 6px 14px rgba(59,130,246,0.16);
      transition: all 0.2s;
    }
    .btn:hover{transform: translateY(-2px); box-shadow:0 8px 18px rgba(59,130,246,0.25);}
    .btn.ghost{background:transparent;color:#0f172a;border:1px solid rgba(15,23,42,0.06);box-shadow:none}
    .btn.ghost:hover{background:rgba(15,23,42,0.03);transform:none;box-shadow:none}
    .btn.success{background:linear-gradient(90deg,#10b981,#34d399);box-shadow:0 6px 14px rgba(16,185,129,0.16)}
    .btn.warning{background:linear-gradient(90deg,#f59e0b,#fbbf24);box-shadow:0 6px 14px rgba(245,158,11,0.16)}
    .btn.danger{background:linear-gradient(90deg,#ef4444,#f87171);box-shadow:0 6px 14px rgba(239,68,68,0.16)}
    .small{padding:6px 8px;font-size:13px;border-radius:8px}
    input,select,textarea{padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);outline:none;width:100%;font-size:14px;background:#fff;transition:border 0.2s}
    input:focus,select:focus,textarea:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}

    /* responsive */
    @media (max-width:900px){
      .app{grid-template-columns:1fr; padding:12px}
      .sidebar{order:2; height: auto; position: static;}
      .main{order:1}
    }

    /* tiny utilities */
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#fde68a,#fca5a5);font-weight:700}
    .badge{display:inline-block;padding:6px 8px;border-radius:8px;background:#eef2ff;font-weight:700;color:#3730a3}
    .status{display:inline-block;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600}
    .status.active{background:#d1fae5;color:#065f46}
    .status.inactive{background:#fee2e2;color:#991b1b}
    .status.pending{background:#fef3c7;color:#92400e}

    /* form layout inside sections */
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form-grid .full{grid-column:1/-1}
    .muted-2{color:#374151}

    /* modal */
    .modal{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:30;
      backdrop-filter: blur(4px);
    }
    .modal.open{display:flex}
    .modal .box{width:720px;max-width:96%;background:var(--card);padding:18px;border-radius:12px;max-height:90vh;overflow-y:auto}
    .right{margin-left:auto}
    .tiny{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .editable{background:#f8fafc;border-radius:8px;padding:8px}
    
    /* Charts */
    .chart-container{height:300px;width:100%;margin-top:12px}
    
    /* Notifications */
    .notifications{position:fixed;top:20px;right:20px;z-index:40;display:flex;flex-direction:column;gap:8px;max-width:400px}
    .notification{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 10px 25px rgba(0,0,0,0.1);display:flex;align-items:center;gap:10px;animation:slideIn 0.3s ease}
    .notification.success{border-left:4px solid var(--success)}
    .notification.error{border-left:4px solid var(--danger)}
    .notification.warning{border-left:4px solid var(--warning)}
    .notification.info{border-left:4px solid var(--info)}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1}}
    
    /* Profile dropdown */
    .profile-dropdown{position:relative}
    .profile-menu{position:absolute;top:100%;right:0;margin-top:8px;background:var(--card);border-radius:8px;box-shadow:0 10px 25px rgba(0,0,0,0.1);padding:8px;min-width:180px;display:none;z-index:20}
    .profile-menu.open{display:block}
    .profile-menu button{width:100%;text-align:left;padding:8px;border-radius:6px;border:none;background:none;cursor:pointer}
    .profile-menu button:hover{background:rgba(0,0,0,0.05)}
    
    /* Tabs */
    .tabs{display:flex;gap:4px;border-bottom:1px solid rgba(15,23,42,0.1);margin-bottom:12px}
    .tab{padding:8px 16px;border:none;background:none;cursor:pointer;border-radius:6px 6px 0 0;font-weight:500}
    .tab.active{background:var(--card);border-bottom:2px solid #3b82f6}
    
    /* Loading spinner */
    .spinner{width:20px;height:20px;border:2px solid rgba(59,130,246,0.3);border-radius:50%;border-top-color:#3b82f6;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* Export buttons */
    .export-buttons{display:flex;gap:8px;margin-top:12px}
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">AP</div>
        <div>
          <div class="panel-title">Admin panel</div>
          <div class="tiny">Minimal UI</div>
        </div>
      </div>

      <nav class="nav" aria-label="navigation">
        <button class="active" data-section="dashboard">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Statistikalar
        </button>
        <button data-section="users">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M9 11C11.2091 11 13 9.20914 13 7C13 4.79086 11.2091 3 9 3C6.79086 3 5 4.79086 5 7C5 9.20914 6.79086 11 9 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89318 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Foydalanuvchilar
        </button>
        <button data-section="schools">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 14L21 9L12 4L3 9L12 14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 14V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M17 19V12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7 19V12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Maktablar
        </button>
        <button data-section="settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19.4 15C19.2662 15.3052 19.1993 15.6365 19.2 16C19.2 16.727 19.505 17.405 20.031 17.903C20.298 18.159 20.4 18.517 20.4 18.9C20.4 19.5 20 20 19.4 20H18C17.6 20 17.2 19.8 17 19.4C16.8 19 16.5 18.6 16.2 18.2C15.9 17.8 15.5 17.4 15 17C14.6 16.6 14.1 16.3 13.6 16C13.2 15.7 12.7 15.5 12.2 15.3C11.7 15.1 11.2 15 10.7 15H9.3C8.8 15 8.3 15.1 7.8 15.3C7.3 15.5 6.8 15.7 6.4 16C5.9 16.3 5.5 16.6 5.1 17C4.7 17.4 4.4 17.8 4.1 18.2C3.8 18.6 3.5 19 3.3 19.4C3.1 19.8 2.7 20 2.3 20H1C0.4 20 0 19.5 0 18.9C0 18.5 0.1 18.1 0.4 17.9C0.9 17.4 1.2 16.7 1.2 16C1.2 15.6 1.1 15.3 1 15C0.9 14.7 0.7 14.4 0.5 14.1C0.3 13.8 0.1 13.5 0 13.1C0 12.5 0.4 12 1 12H2.3C2.7 12 3.1 12.2 3.3 12.6C3.5 13 3.8 13.4 4.1 13.8C4.4 14.2 4.7 14.6 5.1 15C5.5 15.4 6 15.7 6.4 16C6.8 16.3 7.3 16.5 7.8 16.7C8.3 16.9 8.8 17 9.3 17H10.7C11.2 17 11.7 16.9 12.2 16.7C12.7 16.5 13.2 16.3 13.6 16C14 15.7 14.5 15.4 14.9 15C15.3 14.6 15.6 14.2 15.9 13.8C16.2 13.4 16.5 13 16.7 12.6C16.9 12.2 17.3 12 17.7 12H19C19.6 12 20 12.5 20 13.1C20 13.5 19.9 13.9 19.6 14.1C19.1 14.6 18.8 15.3 18.8 16C18.8 16.4 18.9 16.7 19 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Sozlamalar
        </button>
        <button data-section="plans">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Tariflar
        </button>
        <button data-section="profile">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Profil
        </button>
      </nav>

      <div class="mini-stat">
        <div class="stat-card">
          <div class="n" id="stat-schools">0</div>
          <div class="l">Maktablar</div>
        </div>
        <div class="stat-card">
          <div class="n" id="stat-staff">0</div>
          <div class="l">Xodimlar</div>
        </div>
        <div class="stat-card">
          <div class="n" id="stat-students">0</div>
          <div class="l">O'quvchilar</div>
        </div>
      </div>

      <div class="muted tiny">© 2025 · Sizning kompaniya</div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="top">
        <div class="search card">
          <input id="globalSearch" placeholder="Qidiruv... (maktab, ism, role)" />
          <button class="btn ghost small" id="searchBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 21L16.514 16.506L21 21ZM19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Qidir
          </button>
        </div>
        <div class="row">
          <div class="profile-dropdown">
            <div class="badge" id="userBadge">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Hozir: <strong id="currentUser">Guest</strong>
            </div>
            <div class="profile-menu" id="profileMenu">
              <button id="profileBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 12C14.2091 12 16 10.2091 16 8C16 5.79086 14.2091 4 12 4C9.79086 4 8 5.79086 8 8C8 10.2091 9.79086 12 12 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M6 20C6 17.7909 7.79086 16 10 16H14C16.2091 16 18 17.7909 18 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Profil
              </button>
              <button id="settingsBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M19.4 15C19.2662 15.3052 19.1993 15.6365 19.2 16C19.2 16.727 19.505 17.405 20.031 17.903C20.298 18.159 20.4 18.517 20.4 18.9C20.4 19.5 20 20 19.4 20H18C17.6 20 17.2 19.8 17 19.4C16.8 19 16.5 18.6 16.2 18.2C15.9 17.8 15.5 17.4 15 17C14.6 16.6 14.1 16.3 13.6 16C13.2 15.7 12.7 15.5 12.2 15.3C11.7 15.1 11.2 15 10.7 15H9.3C8.8 15 8.3 15.1 7.8 15.3C7.3 15.5 6.8 15.7 6.4 16C5.9 16.3 5.5 16.6 5.1 17C4.7 17.4 4.4 17.8 4.1 18.2C3.8 18.6 3.5 19 3.3 19.4C3.1 19.8 2.7 20 2.3 20H1C0.4 20 0 19.5 0 18.9C0 18.5 0.1 18.1 0.4 17.9C0.9 17.4 1.2 16.7 1.2 16C1.2 15.6 1.1 15.3 1 15C0.9 14.7 0.7 14.4 0.5 14.1C0.3 13.8 0.1 13.5 0 13.1C0 12.5 0.4 12 1 12H2.3C2.7 12 3.1 12.2 3.3 12.6C3.5 13 3.8 13.4 4.1 13.8C4.4 14.2 4.7 14.6 5.1 15C5.5 15.4 6 15.7 6.4 16C6.8 16.3 7.3 16.5 7.8 16.7C8.3 16.9 8.8 17 9.3 17H10.7C11.2 17 11.7 16.9 12.2 16.7C12.7 16.5 13.2 16.3 13.6 16C14 15.7 14.5 15.4 14.9 15C15.3 14.6 15.6 14.2 15.9 13.8C16.2 13.4 16.5 13 16.7 12.6C16.9 12.2 17.3 12 17.7 12H19C19.6 12 20 12.5 20 13.1C20 13.5 19.9 13.9 19.6 14.1C19.1 14.6 18.8 15.3 18.8 16C18.8 16.4 18.9 16.7 19 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Sozlamalar
              </button>
              <button id="doLogoutMenu">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M16 17L21 12L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Chiqish
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- NOTIFICATIONS -->
      <div class="notifications" id="notifications"></div>

      <!-- CONTENT AREA -->
      <section id="dashboard" class="card content-section">
        <h2>Statistikalar</h2>
        
        <div class="tabs" id="dashboardTabs">
          <button class="tab active" data-tab="overview">Umumiy ko'rinish</button>
          <button class="tab" data-tab="charts">Diagrammalar</button>
          <button class="tab" data-tab="reports">Hisobotlar</button>
        </div>
        
        <div id="dashboardOverview" class="dashboard-tab">
          <div class="grid" style="grid-template-columns:repeat(3,1fr)">
            <div class="card">
              <div class="muted tiny">Maktablar soni</div>
              <div style="font-size:22px;font-weight:800" id="dash-schools">0</div>
            </div>
            <div class="card">
              <div class="muted tiny">Xodimlar jami</div>
              <div style="font-size:22px;font-weight:800" id="dash-staff">0</div>
            </div>
            <div class="card">
              <div class="muted tiny">O'quvchilar jami</div>
              <div style="font-size:22px;font-weight:800" id="dash-students">0</div>
            </div>
          </div>

          <div style="margin-top:12px" class="card">
            <h3 style="margin-bottom:10px">Tezkor ma'lumotlar</h3>
            <div class="row">
              <div class="pill">Aktiv foydalanuvchilar: <strong id="activeUsers">0</strong></div>
              <div class="tiny right">Oxirgi yangilanish: <span id="lastUpdated">—</span></div>
            </div>
          </div>
          
          <div class="export-buttons">
            <button class="btn ghost small" id="exportData">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Ma'lumotlarni yuklab olish
            </button>
            <button class="btn ghost small" id="importData">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M17 8L12 3L7 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Ma'lumotlarni yuklash
            </button>
          </div>
        </div>
        
        <div id="dashboardCharts" class="dashboard-tab" style="display:none">
          <div class="card">
            <h3>Statistika diagrammalari</h3>
            <div class="chart-container" id="statsChart">
              <p style="text-align:center;padding:40px">Diagrammalar bu yerda ko'rsatiladi</p>
            </div>
          </div>
        </div>
        
        <div id="dashboardReports" class="dashboard-tab" style="display:none">
          <div class="card">
            <h3>Hisobotlar</h3>
            <p>Hisobotlar tayyorlanmoqda...</p>
          </div>
        </div>
      </section>

      <section id="users" class="card content-section" style="display:none">
        <h2>Foydalanuvchilar</h2>
        <div class="row" style="justify-content:space-between">
          <div class="muted">Xodimlar va o'quvchilarni boshqarish</div>
          <div>
            <button class="btn" id="addStaffBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Xodim qo'shish
            </button>
            <button class="btn ghost" id="addStudentBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              O'quvchi qo'shish
            </button>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <h3>Xodimlar</h3>
          <table id="staffTable">
            <thead><tr><th>Ism</th><th>Lavozim</th><th>Telefon</th><th>Email</th><th>Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:12px" class="card">
          <h3>O'quvchilar</h3>
          <table id="studentTable">
            <thead><tr><th>Ism</th><th>Maktab</th><th>Yosh</th><th>Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="schools" class="card content-section" style="display:none">
        <h2>Maktablar</h2>
        <div class="row" style="justify-content:space-between">
          <div class="muted">Maktab qo'shish va hudud bo'yicha ko'rish</div>
          <div>
            <button class="btn" id="openAddSchool">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Maktab qo'shish
            </button>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <h3>Filtrlash: Hudud bo'yicha</h3>
          <div class="row">
            <select id="filterRegion">
              <option value="">— Hammasi —</option>
            </select>
            <input id="filterDistrict" placeholder="tuman bo'yicha qidir..." />
            <button class="btn ghost" id="filterBtn">Filtrlash</button>
            <button class="btn" id="clearFilter">Tozalash</button>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <h3>Maktablar ro'yxati</h3>
          <table id="schoolsTable">
            <thead><tr><th>Nomi</th><th>Hudud</th><th>O'quvchilar</th><th>Xodimlar</th><th>Kontakt</th><th>Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="settings" class="card content-section" style="display:none">
        <h2>Sozlamalar</h2>
        <div class="grid" style="grid-template-columns:1fr 360px">
          <div class="card">
            <h3>Rollar</h3>
            <div id="rolesList"></div>
            <div style="margin-top:8px" class="row">
              <input id="newRoleName" placeholder="Yangi rol nomi" />
              <button class="btn" id="addRoleBtn">Qo'shish</button>
            </div>
          </div>

          <div class="card">
            <h3>Huquqlar (tahrirlash)</h3>
            <div id="rolePerms" class="editable">Bir rolni chapdan tanlang — huquqlar shu yerda ko'rsatiladi.</div>
          </div>
        </div>
        
        <div style="margin-top:12px" class="card">
          <h3>Tizim sozlamalari</h3>
          <div class="form-grid">
            <div>
              <label>Til</label>
              <select id="systemLanguage">
                <option value="uz">O'zbek</option>
                <option value="ru">Русский</option>
                <option value="en">English</option>
              </select>
            </div>
            <div>
              <label>Vaqt formati</label>
              <select id="timeFormat">
                <option value="24">24 soat</option>
                <option value="12">12 soat</option>
              </select>
            </div>
            <div>
              <label>Bildirishnomalar</label>
              <select id="notifications">
                <option value="all">Barchasi</option>
                <option value="important">Faqat muhimlari</option>
                <option value="none">O'chirilgan</option>
              </select>
            </div>
            <div>
              <label>Avtomatik saqlash</label>
              <select id="autoSave">
                <option value="5">5 soniya</option>
                <option value="10">10 soniya</option>
                <option value="30">30 soniya</option>
                <option value="0">O'chirilgan</option>
              </select>
            </div>
          </div>
          <div class="actions">
            <button class="btn" id="saveSettings">Sozlamalarni saqlash</button>
          </div>
        </div>
      </section>

      <section id="plans" class="card content-section" style="display:none">
        <h2>Tariflar (oylik)</h2>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="muted">Tariflar ro'yxati va funksionalliklari</div>
          <div>
            <button class="btn" id="addPlanBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Tarif qo'shish
            </button>
          </div>
        </div>
        <div style="margin-top:12px" class="card">
          <table id="plansTable">
            <thead><tr><th>Nomi</th><th>Narx (so'm)</th><th>Funksionalliklar</th><th>Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="profile" class="card content-section" style="display:none">
        <h2>Profil</h2>
        <div class="form-grid">
          <div>
            <label>Ism</label>
            <input id="profileName" value="Admin" />
          </div>
          <div>
            <label>Familiya</label>
            <input id="profileSurname" value="Foydalanuvchi" />
          </div>
          <div>
            <label>Email</label>
            <input id="profileEmail" value="admin@example.com" />
          </div>
          <div>
            <label>Telefon</label>
            <input id="profilePhone" value="+998901234567" />
          </div>
          <div>
            <label>Yangi parol</label>
            <input id="profilePassword" type="password" placeholder="Agar o'zgartirmoqchi bo'lsangiz" />
          </div>
          <div>
            <label>Parolni tasdiqlash</label>
            <input id="profilePasswordConfirm" type="password" placeholder="Yangi parolni qayta kiriting" />
          </div>
          <div class="full">
            <div class="actions">
              <button class="btn" id="saveProfile">Profilni saqlash</button>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- MODAL: ADD SCHOOL -->
  <div class="modal" id="modalSchool">
    <div class="box">
      <h3>Maktab qo'shish</h3>
      <div class="form-grid" style="margin-top:8px">
        <div>
          <label>Viloyat</label>
          <input id="schoolRegion" placeholder="Viloyat..." />
        </div>
        <div>
          <label>Tuman</label>
          <input id="schoolDistrict" placeholder="Tuman..." />
        </div>
        <div class="full">
          <label>Maktab nomi</label>
          <input id="schoolName" placeholder="Maktab nomi..." />
        </div>
        <div>
          <label>Website (agar bor bo'lsa)</label>
          <input id="schoolWebsite" placeholder="https://..." />
        </div>
        <div>
          <label>O'quvchilar soni</label>
          <input id="schoolStudents" type="number" value="0" />
        </div>
        <div>
          <label>Xodimlar soni</label>
          <input id="schoolStaff" type="number" value="0" />
        </div>
        <div>
          <label>Mas'ul xodim ismi</label>
          <input id="schoolManager" placeholder="Ism..." />
        </div>
        <div>
          <label>Kontakt telefon</label>
          <input id="schoolPhone" placeholder="+998..." />
        </div>
        <div class="full">
          <label>Email</label>
          <input id="schoolEmail" placeholder="email@example.com" />
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" id="closeModal">Bekor qilish</button>
        <button class="btn" id="saveSchool">Saqlash</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ADD STAFF/STUDENT -->
  <div class="modal" id="modalPerson">
    <div class="box">
      <h3 id="personTitle">Xodim qo'shish</h3>
      <div style="margin-top:8px" class="form-grid">
        <div><label>Ism</label><input id="personName" /></div>
        <div id="personRoleWrap"><label>Lavozim</label><input id="personRole" /></div>
        <div id="personSchoolWrap"><label>Maktab</label><select id="personSchool"></select></div>
        <div><label>Telefon</label><input id="personPhone" /></div>
        <div><label>Email</label><input id="personEmail" /></div>
        <div id="personAgeWrap"><label>Yosh</label><input id="personAge" type="number" /></div>
        <div><label>Status</label>
          <select id="personStatus">
            <option value="active">Aktiv</option>
            <option value="inactive">Aktiv emas</option>
            <option value="pending">Kutilmoqda</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" id="closePerson">Bekor</button>
        <button class="btn" id="savePerson">Saqlash</button>
      </div>
    </div>
  </div>

  <!-- MODAL: LOGIN -->
  <div class="modal" id="modalLogin">
    <div class="box" style="max-width:400px">
      <h3>Tizimga kirish</h3>
      <div style="margin-top:8px">
        <div>
          <label>Login</label>
          <input id="loginUser" value="admin" />
        </div>
        <div style="margin-top:12px">
          <label>Parol</label>
          <input id="loginPass" type="password" value="1234" />
        </div>
        <div style="margin-top:12px" class="muted tiny">
          Demo login: <strong>admin</strong> / <strong>1234</strong>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" id="closeLogin">Bekor qilish</button>
        <button class="btn" id="doLogin">Kirish</button>
      </div>
    </div>
  </div>

  <!-- JS -->
<script>
/* --- Demo boshlang'ich ma'lumotlar (yangilangan) --- */
const data = {
  currentUser: null,
  // demo userlar: username, password (plain demo uchun), role, displayName, avatar (optional)
  authUsers: [
    { username: 'admin', password: '1234', role: 'Superadmin', displayName: 'Admin', avatar: '' },
    { username: 'director', password: 'dir2025', role: 'Direktor', displayName: 'Ali Karimov', avatar: '' },
    { username: 'account', password: 'acc123', role: 'Bugalteriya', displayName: 'Gulbahor R.', avatar: '' }
  ],
  loginAttempts: {}, // track attempts per username
  users: {
    staff: [
      {id:1, name:'Ali Karimov', role:'Direktor', phone:'+998901234567', email:'ali@school.uz', schoolId:1, status:'active'},
      {id:2, name:'Gulbahor Rustamova', role:'Bugalteriya', phone:'+998907654321', email:'gulbahor@school.uz', schoolId:1, status:'active'},
    ],
    students: [
      {id:1, name:'Javlon A.', age:12, schoolId:1, status:'active'},
      {id:2, name:'Nodira B.', age:11, schoolId:1, status:'active'},
    ]
  },
  schools: [
    {id:1, region:'Toshkent viloyati', district:'Parkent', name:'Parkent 1-son maktab', website:'', students:200, staff:12, manager:'Ali Karimov', phone:'+998901234567', email:'parkent1@edu.uz', status:'active'},
    {id:2, region:'Samarqand', district:'Bulungur', name:'Bulungur maktabi', website:'http://bulungur.edu.uz', students:120, staff:8, manager:'Zoir Mirzaev', phone:'+998909001122', email:'bulungur@edu.uz', status:'active'}
  ],
  roles: [
    {id:1,name:'Superadmin', perms:['maktab:crud','user:crud','settings:edit']},
    {id:2,name:'Direktor', perms:['maktab:view','students:manage']},
    {id:3,name:'Bugalteriya', perms:['finance:view']}
  ],
  plans: [
    {id:1,name:'Basic', price:50000, features:'Ro\'yxat, statistika', status:'active'},
    {id:2,name:'Pro', price:150000, features:'Hammasi: import/export, cheksiz maktab', status:'active'}
  ],
  settings: {
    language: 'uz',
    timeFormat: '24',
    notifications: 'all',
    autoSave: 5
  }
};

/* --- Elementlar --- */
const sections = document.querySelectorAll('.content-section');
const navButtons = document.querySelectorAll('.nav button');
const statSchools = document.getElementById('stat-schools');
const statStaff = document.getElementById('stat-staff');
const statStudents = document.getElementById('stat-students');
const dashSchools = document.getElementById('dash-schools');
const dashStaff = document.getElementById('dash-staff');
const dashStudents = document.getElementById('dash-students');
const lastUpdated = document.getElementById('lastUpdated');
const currentUserEl = document.getElementById('currentUser');
const userBadge = document.getElementById('userBadge');
const profileMenu = document.getElementById('profileMenu');
const notificationsContainer = document.getElementById('notifications');

/* --- Helper: permission tekshiruvi --- */
function hasPerm(perm) {
  if(!data.currentUser) return false;
  const u = data.authUsers.find(x => x.username === data.currentUser);
  if(!u) return false;
  const roleObj = data.roles.find(r => r.name === u.role);
  return roleObj ? roleObj.perms.includes(perm) : false;
}

/* --- Notification system --- */
function showNotification(message, type = 'info', duration = 5000) {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  let icon = '';
  switch(type) {
    case 'success': 
      icon = '✔';
      break;
    case 'error':
      icon = '✖';
      break;
    case 'warning':
      icon = '!';
      break;
    default:
      icon = 'i';
  }
  notification.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px">
      <div style="font-weight:bold">${icon}</div>
      <div style="flex:1">${message}</div>
      <button class="btn ghost tiny" style="margin-left:8px" onclick="this.parentElement.parentElement.remove()">×</button>
    </div>
  `;
  notificationsContainer.appendChild(notification);
  if (duration > 0) {
    setTimeout(() => { if (notification.parentElement) notification.remove(); }, duration);
  }
}

/* --- Navigation --- */
navButtons.forEach(btn=>{
  btn.addEventListener('click',()=>{
    const sec = btn.dataset.section;
    // Protected sections example: dashboard, staff, schools, plans, settings
    const protectedSections = ['dashboard','staffs','schools','plans','settings','roles','profile'];
    if (protectedSections.includes(sec) && !data.currentUser) {
      showNotification('Bu bo\'limga kirish uchun tizimga kiring', 'warning');
      document.getElementById('modalLogin').classList.add('open');
      return;
    }
    navButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    sections.forEach(s=> s.id === sec ? s.style.display='block' : s.style.display='none');
    if (sec === 'dashboard') {
      document.querySelectorAll('.dashboard-tab').forEach(tab => tab.style.display = 'none');
      document.getElementById('dashboardOverview').style.display = 'block';
      document.querySelectorAll('#dashboardTabs .tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector('#dashboardTabs .tab[data-tab="overview"]').classList.add('active');
    }
  });
});

/* --- Dashboard tabs --- */
document.querySelectorAll('#dashboardTabs .tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const tabName = tab.dataset.tab;
    document.querySelectorAll('#dashboardTabs .tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.dashboard-tab').forEach(t => t.style.display = 'none');
    document.getElementById(`dashboard${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).style.display = 'block';
  });
});

/* --- Profile dropdown --- */
if (userBadge) {
  userBadge.addEventListener('click', (e) => {
    e.stopPropagation();
    profileMenu.classList.toggle('open');
  });
}

/* close profile on document click */
document.addEventListener('click', () => {
  if (profileMenu) profileMenu.classList.remove('open');
});

/* --- Statistikani yangilash --- */
function refreshStats(){
  statSchools.textContent = data.schools.length;
  statStaff.textContent = data.users.staff.length;
  statStudents.textContent = data.users.students.length;
  dashSchools.textContent = data.schools.length;
  dashStaff.textContent = data.users.staff.length;
  dashStudents.textContent = data.users.students.length;
  const activeCount = data.users.staff.length + data.users.students.length;
  const activeUsersEl = document.getElementById('activeUsers');
  if(activeUsersEl) activeUsersEl.textContent = activeCount;
  if(lastUpdated) lastUpdated.textContent = new Date().toLocaleString();
}

/* --- Populate tables --- */
function renderStaff(){
  const tbody = document.querySelector('#staffTable tbody'); if(!tbody) return; tbody.innerHTML='';
  data.users.staff.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.role}</td><td>${s.phone || '—'}</td><td>${s.email || '—'}</td>
      <td><span class="status ${s.status}">${s.status === 'active' ? 'Aktiv' : s.status === 'inactive' ? 'Aktiv emas' : 'Kutilmoqda'}</span></td>
      <td>
        <button class="small btn ghost" data-id="${s.id}" data-action="edit-staff">Tahrirlash</button>
        <button class="small btn" data-id="${s.id}" data-action="del-staff">O'chirish</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function renderStudents(){
  const tbody = document.querySelector('#studentTable tbody'); if(!tbody) return; tbody.innerHTML='';
  data.users.students.forEach(s=>{
    const school = data.schools.find(x=>x.id===s.schoolId);
    const schoolName = school ? school.name : '—';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${schoolName}</td><td>${s.age || '—'}</td>
      <td><span class="status ${s.status}">${s.status === 'active' ? 'Aktiv' : s.status === 'inactive' ? 'Aktiv emas' : 'Kutilmoqda'}</span></td>
      <td>
        <button class="small btn ghost" data-id="${s.id}" data-action="edit-student">Tahrirlash</button>
        <button class="small btn" data-id="${s.id}" data-action="del-student">O'chirish</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function renderSchools(filter = {}) {
  const tbody = document.querySelector('#schoolsTable tbody'); if(!tbody) return; tbody.innerHTML='';
  const rows = data.schools.filter(s=>{
    if(filter.region && s.region !== filter.region) return false;
    if(filter.district && !s.district.toLowerCase().includes(filter.district.toLowerCase())) return false;
    return true;
  });
  rows.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.region} / ${s.district}</td><td>${s.students}</td><td>${s.staff}</td><td>${s.phone || '—'}</td>
      <td><span class="status ${s.status}">${s.status === 'active' ? 'Aktiv' : s.status === 'inactive' ? 'Aktiv emas' : 'Kutilmoqda'}</span></td>
      <td>
        <button class="small btn ghost" data-id="${s.id}" data-action="view-school">Ko'rish</button>
        <button class="small btn" data-id="${s.id}" data-action="del-school">O'chirish</button>
      </td>`;
    tbody.appendChild(tr);
  });
  // fill filter regions
  const regSel = document.getElementById('filterRegion');
  if(regSel){
    const regions = Array.from(new Set(data.schools.map(x=>x.region)));
    regSel.innerHTML = '<option value="">— Hammasi —</option>' + regions.map(r=>`<option value="${r}">${r}</option>`).join('');
  }
}

function renderRoles(){
  const wrap = document.getElementById('rolesList'); if(!wrap) return; wrap.innerHTML='';
  data.roles.forEach(r=>{
    const div = document.createElement('div');
    div.style.display='flex';div.style.justifyContent='space-between';div.style.alignItems='center';div.style.padding='8px 0';
    div.innerHTML = `<div><strong>${r.name}</strong><div class="tiny">${r.perms.join(', ') || '—'}</div></div>
      <div>
        <button class="small btn ghost" data-id="${r.id}" data-action="edit-role">Tahrirlash</button>
        <button class="small btn" data-id="${r.id}" data-action="del-role">O'chirish</button>
      </div>`;
    wrap.appendChild(div);
  });
}

function renderPlans(){
  const tbody = document.querySelector('#plansTable tbody'); if(!tbody) return; tbody.innerHTML='';
  data.plans.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.name}</td><td>${p.price.toLocaleString()}</td><td>${p.features}</td>
      <td><span class="status ${p.status}">${p.status === 'active' ? 'Aktiv' : 'Aktiv emas'}</span></td>
      <td>
        <button class="small btn ghost" data-id="${p.id}" data-action="edit-plan">Tahrirlash</button>
        <button class="small btn" data-id="${p.id}" data-action="del-plan">O'chirish</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* --- Settings form --- */
function loadSettings() {
  if(document.getElementById('systemLanguage')) document.getElementById('systemLanguage').value = data.settings.language;
  if(document.getElementById('timeFormat')) document.getElementById('timeFormat').value = data.settings.timeFormat;
  if(document.getElementById('notifications')) document.getElementById('notifications').value = data.settings.notifications;
  if(document.getElementById('autoSave')) document.getElementById('autoSave').value = data.settings.autoSave;
}

/* --- Initial render --- */
function initialRender(){
  renderStaff(); renderStudents(); renderSchools(); renderRoles(); renderPlans(); refreshStats();
  currentUserEl.textContent = data.currentUser || 'Guest';
  loadSettings();
  updateUserBadgeUI();
}
initialRender();

/* --- Modallar va formalar --- */
const modalSchool = document.getElementById('modalSchool');
if (document.getElementById('openAddSchool')) {
  document.getElementById('openAddSchool').addEventListener('click',()=>{ 
    if (!data.currentUser) {
      showNotification('Bu amalni bajarish uchun tizimga kiring', 'warning');
      document.getElementById('modalLogin').classList.add('open');
      return;
    }
    modalSchool.classList.add('open'); 
  });
}
if (document.getElementById('closeModal')) document.getElementById('closeModal').addEventListener('click',()=>{ modalSchool.classList.remove('open'); });
if (document.getElementById('saveSchool')) document.getElementById('saveSchool').addEventListener('click',()=>{/* ... same as before ... */
  const regionEl = document.getElementById('schoolRegion');
  const districtEl = document.getElementById('schoolDistrict');
  const nameEl = document.getElementById('schoolName');
  if(!regionEl || !districtEl || !nameEl) return;
  const region = regionEl.value.trim();
  const district = districtEl.value.trim();
  const name = nameEl.value.trim();
  if(!region || !district || !name){ 
    showNotification('Iltimos, viloyat, tuman va nomni to\'ldiring', 'warning');
    return; 
  }
  const newId = Date.now();
  const school = {
    id:newId, region, district, name,
    website:document.getElementById('schoolWebsite')?.value.trim()||'',
    students:parseInt(document.getElementById('schoolStudents')?.value)||0,
    staff:parseInt(document.getElementById('schoolStaff')?.value)||0,
    manager:document.getElementById('schoolManager')?.value.trim()||'',
    phone:document.getElementById('schoolPhone')?.value.trim()||'',
    email:document.getElementById('schoolEmail')?.value.trim()||'',
    status: 'active'
  };
  data.schools.push(school);
  modalSchool.classList.remove('open');
  ['schoolRegion','schoolDistrict','schoolName','schoolWebsite','schoolStudents','schoolStaff','schoolManager','schoolPhone','schoolEmail'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  renderSchools(); refreshStats(); 
  showNotification('Maktab muvaffaqiyatli qo\'shildi', 'success');
});

/* --- Filter controls --- */
if(document.getElementById('filterBtn')) document.getElementById('filterBtn').addEventListener('click',()=>{
  const region = document.getElementById('filterRegion')?.value;
  const district = document.getElementById('filterDistrict')?.value.trim();
  renderSchools({region,district});
});
if(document.getElementById('clearFilter')) document.getElementById('clearFilter').addEventListener('click',()=>{
  if(document.getElementById('filterRegion')) document.getElementById('filterRegion').value='';
  if(document.getElementById('filterDistrict')) document.getElementById('filterDistrict').value='';
  renderSchools();
});

/* --- Add staff/student modal --- */
const modalPerson = document.getElementById('modalPerson');
const personTitle = document.getElementById('personTitle');
const personSchoolSel = document.getElementById('personSchool');

function openPersonModal(type, id=null){
  if (!data.currentUser) {
    showNotification('Bu amalni bajarish uchun tizimga kiring', 'warning');
    document.getElementById('modalLogin').classList.add('open');
    return;
  }
  modalPerson.classList.add('open');
  personTitle.textContent = type === 'staff' ? 'Xodim qo\'shish' : 'O\'quvchi qo\'shish';
  // clear fields
  if(document.getElementById('personName')) document.getElementById('personName').value='';
  if(document.getElementById('personRole')) document.getElementById('personRole').value='';
  if(document.getElementById('personPhone')) document.getElementById('personPhone').value='';
  if(document.getElementById('personEmail')) document.getElementById('personEmail').value='';
  if(document.getElementById('personAge')) document.getElementById('personAge').value='';
  if(document.getElementById('personStatus')) document.getElementById('personStatus').value='active';
  if(personSchoolSel) personSchoolSel.innerHTML = data.schools.map(s=>`<option value="${s.id}">${s.name} — ${s.region}</option>`).join('');
  if(type==='student'){ 
    if(document.getElementById('personRoleWrap')) document.getElementById('personRoleWrap').style.display='none'; 
    if(document.getElementById('personAgeWrap')) document.getElementById('personAgeWrap').style.display='block'; 
  }
  else { 
    if(document.getElementById('personRoleWrap')) document.getElementById('personRoleWrap').style.display='block'; 
    if(document.getElementById('personAgeWrap')) document.getElementById('personAgeWrap').style.display='none'; 
  }
  modalPerson.dataset.type = type;
  modalPerson.dataset.editId = id || '';
  if (id) {
    let person;
    if (type === 'staff') person = data.users.staff.find(x => x.id === id);
    else person = data.users.students.find(x => x.id === id);
    if (person) {
      document.getElementById('personName').value = person.name || '';
      document.getElementById('personSchool').value = person.schoolId || '';
      document.getElementById('personStatus').value = person.status || 'active';
      if (type === 'staff') {
        document.getElementById('personRole').value = person.role || '';
        document.getElementById('personPhone').value = person.phone || '';
        document.getElementById('personEmail').value = person.email || '';
      } else {
        document.getElementById('personAge').value = person.age || '';
      }
    }
  }
}
if(document.getElementById('addStaffBtn')) document.getElementById('addStaffBtn').addEventListener('click',()=>openPersonModal('staff'));
if(document.getElementById('addStudentBtn')) document.getElementById('addStudentBtn').addEventListener('click',()=>openPersonModal('student'));
if(document.getElementById('closePerson')) document.getElementById('closePerson').addEventListener('click',()=>modalPerson.classList.remove('open'));
if(document.getElementById('savePerson')) document.getElementById('savePerson').addEventListener('click',()=>{
  const type = modalPerson.dataset.type;
  const editId = modalPerson.dataset.editId;
  const name = document.getElementById('personName').value.trim();
  const schoolId = parseInt(document.getElementById('personSchool').value);
  const status = document.getElementById('personStatus').value;
  if(!name){ showNotification('Ism kiriting', 'warning'); return; }
  if (editId) {
    if(type==='staff'){
      const staff = data.users.staff.find(x => x.id === parseInt(editId));
      if (staff) {
        staff.name = name;
        staff.role = document.getElementById('personRole').value.trim() || 'Xodim';
        staff.phone = document.getElementById('personPhone').value.trim();
        staff.email = document.getElementById('personEmail').value.trim();
        staff.schoolId = schoolId;
        staff.status = status;
      }
    } else {
      const student = data.users.students.find(x => x.id === parseInt(editId));
      if (student) {
        student.name = name;
        student.age = parseInt(document.getElementById('personAge').value) || null;
        student.schoolId = schoolId;
        student.status = status;
      }
    }
    showNotification(`${type === 'staff' ? 'Xodim' : 'O\'quvchi'} muvaffaqiyatli tahrirlandi`, 'success');
  } else {
    if(type==='staff'){
      const role = document.getElementById('personRole').value.trim() || 'Xodim';
      const phone = document.getElementById('personPhone').value.trim();
      const email = document.getElementById('personEmail').value.trim();
      const newId = Date.now();
      data.users.staff.push({id:newId,name,role,phone,email,schoolId,status});
    } else {
      const age = parseInt(document.getElementById('personAge').value) || null;
      const newId = Date.now();
      data.users.students.push({id:newId,name,age,schoolId,status});
    }
    showNotification(`Yangi ${type === 'staff' ? 'xodim' : 'o\'quvchi'} qo'shildi`, 'success');
  }
  modalPerson.classList.remove('open');
  renderStaff(); renderStudents(); refreshStats();
});

/* --- Table actions delegation --- */
document.addEventListener('click',(e)=>{
  const act = e.target.dataset.action;
  if(!act) return;
  const id = parseInt(e.target.dataset.id);
  // Check if user is logged in for actions
  if (!data.currentUser) {
    showNotification('Bu amalni bajarish uchun tizimga kiring', 'warning');
    document.getElementById('modalLogin').classList.add('open');
    return;
  }
  // staff actions
  if(act==='del-staff'){ 
    if(confirm('Xodim o\'chiriladi. Davom etilsinmi?')){ 
      data.users.staff = data.users.staff.filter(x=>x.id!==id); 
      renderStaff(); 
      refreshStats(); 
      showNotification('Xodim o\'chirildi', 'info');
    } 
  }
  if(act==='edit-staff'){ openPersonModal('staff', id); }
  // student
  if(act==='del-student'){ 
    if(confirm('O\'quvchi o\'chiriladi. Davom etilsinmi?')){ 
      data.users.students = data.users.students.filter(x=>x.id!==id); 
      renderStudents(); 
      refreshStats(); 
      showNotification('O\'quvchi o\'chirildi', 'info');
    } 
  }
  if(act==='edit-student'){ openPersonModal('student', id); }
  // school
  if(act==='del-school'){ 
    if(confirm('Maktab o\'chiriladi. Davom etilsinmi?')){ 
      data.schools = data.schools.filter(x=>x.id!==id); 
      renderSchools(); 
      refreshStats(); 
      showNotification('Maktab o\'chirildi', 'info');
    } 
  }
  if(act==='view-school'){ 
    const s = data.schools.find(x=>x.id===id); 
    alert(`Maktab: ${s.name}\nHudud: ${s.region}/${s.district}\nManager: ${s.manager}\nTelefon: ${s.phone}\nEmail: ${s.email}\nO'quvchilar: ${s.students}\nXodimlar: ${s.staff}`); 
  }
  // roles
  if(act==='del-role'){ 
    if(confirm('Rol o\'chiriladi.')){ 
      data.roles = data.roles.filter(r=>r.id!==id); 
      renderRoles(); 
      showNotification('Rol o\'chirildi', 'info');
    } 
  }
  if(act==='edit-role'){ 
    const r = data.roles.find(x=>x.id===id); 
    const newName = prompt('Rol nomi:', r.name); 
    if(newName){ 
      r.name = newName; 
      r.perms = prompt('Huquqlar (vergul bilan):', r.perms.join(','))?.split(',').map(s=>s.trim()).filter(Boolean) || []; 
      renderRoles(); 
      showNotification('Rol tahrirlandi', 'success');
    } 
  }
  // plans
  if(act==='del-plan'){ 
    if(confirm('Tarif o\'chiriladi.')){ 
      data.plans = data.plans.filter(p=>p.id!==id); 
      renderPlans(); 
      showNotification('Tarif o\'chirildi', 'info');
    } 
  }
  if(act==='edit-plan'){ 
    const p = data.plans.find(x=>x.id===id); 
    const newName = prompt('Nomi:',p.name); 
    if(newName){ 
      p.name=newName; 
      p.price = parseInt(prompt('Narxi:',p.price))||p.price; 
      p.features = prompt('Funksionalliklar:', p.features)||p.features; 
      renderPlans(); 
      showNotification('Tarif tahrirlandi', 'success');
    } 
  }
});

/* --- Roles UI --- */
if(document.getElementById('addRoleBtn')) document.getElementById('addRoleBtn').addEventListener('click',()=>{
  const name = document.getElementById('newRoleName').value.trim();
  if(!name){ 
    showNotification('Rol nomi kiriting', 'warning');
    return; 
  }
  data.roles.push({id:Date.now(), name, perms:[]});
  document.getElementById('newRoleName').value='';
  renderRoles();
  showNotification('Yangi rol qo\'shildi', 'success');
});

/* --- Plans --- */
if(document.getElementById('addPlanBtn')) document.getElementById('addPlanBtn').addEventListener('click',()=>{
  if (!data.currentUser) {
    showNotification('Bu amalni bajarish uchun tizimga kiring', 'warning');
    document.getElementById('modalLogin').classList.add('open');
    return;
  }
  const name = prompt('Tarif nomi:'); if(!name) return;
  const price = parseInt(prompt('Narx (so\'m):', '0')) || 0;
  const features = prompt('Funksionalliklar (vergul bilan):', '—') || '';
  data.plans.push({id:Date.now(), name, price, features, status: 'active'});
  renderPlans();
  showNotification('Yangi tarif qo\'shildi', 'success');
});

/* --- Search --- */
if(document.getElementById('searchBtn')) document.getElementById('searchBtn').addEventListener('click',()=>{
  const q = document.getElementById('globalSearch').value.trim().toLowerCase();
  if(!q){ showNotification('Qidiruv so\'z kiriting', 'warning'); return; }
  const schools = data.schools.filter(s=> (s.name||'').toLowerCase().includes(q) || (s.region||'').toLowerCase().includes(q));
  const staff = data.users.staff.filter(s=> (s.name||'').toLowerCase().includes(q) || (s.role||'').toLowerCase().includes(q));
  const students = data.users.students.filter(s=> (s.name||'').toLowerCase().includes(q));
  let msg = `Natijalar:\nMaktablar: ${schools.length}\nXodimlar: ${staff.length}\nO'quvchilar: ${students.length}`;
  showNotification(msg, 'info', 6000);
});

/* --- Login system (takomillashtirilgan) --- */
const modalLogin = document.getElementById('modalLogin');
const doLogin = document.getElementById('doLogin');
const closeLogin = document.getElementById('closeLogin');
const loginUserInput = document.getElementById('loginUser');
const loginPassInput = document.getElementById('loginPass');

// show login modal when clicking login nav
const loginNavBtn = document.querySelector('.nav button[data-section="login"]');
if (loginNavBtn) loginNavBtn.addEventListener('click', () => modalLogin.classList.add('open'));
if (closeLogin) closeLogin.addEventListener('click', () => modalLogin.classList.remove('open'));

// password show/hide toggle (agar input yonida tushunarlik tugma yo'q bo'lsa yaratamiz)
(function ensureShowPassButton(){
  if(!loginPassInput) return;
  let toggle = document.getElementById('togglePassBtn');
  if(!toggle) {
    toggle = document.createElement('button');
    toggle.type = 'button';
    toggle.id = 'togglePassBtn';
    toggle.className = 'btn ghost tiny';
    toggle.style.marginTop = '8px';
    toggle.textContent = 'Ko\'rsat';
    loginPassInput.insertAdjacentElement('afterend', toggle);
    toggle.addEventListener('click', () => {
      if(loginPassInput.type === 'password'){ loginPassInput.type = 'text'; toggle.textContent = 'Yashir'; }
      else { loginPassInput.type = 'password'; toggle.textContent = 'Ko\'rsat'; }
    });
  }
})();

// login urinishni tekshirish
function canAttemptLogin(username) {
  const info = data.loginAttempts[username];
  if (!info) return true;
  // agar bloklangan bo'lsa, tekshirish va 5 daqiqadan keyin ochish
  if (info.lockUntil && Date.now() < info.lockUntil) return false;
  return true;
}
function recordFailedAttempt(username) {
  if (!data.loginAttempts[username]) data.loginAttempts[username] = { count: 0, last: Date.now(), lockUntil: null };
  data.loginAttempts[username].count++;
  data.loginAttempts[username].last = Date.now();
  if (data.loginAttempts[username].count >= 3) {
    data.loginAttempts[username].lockUntil = Date.now() + 5 * 60 * 1000; // 5 daqiqa blok
  }
}
function resetAttempts(username) {
  if (data.loginAttempts[username]) data.loginAttempts[username] = { count: 0, last: null, lockUntil: null };
}

function setCurrentUser(username) {
  data.currentUser = username;
  localStorage.setItem('admin_demo_session', JSON.stringify({ user: username, ts: Date.now() }));
  currentUserEl.textContent = username;
  showNotification('Kirish muvaffaqiyatli', 'success');
  // nav -> dashboard
  navButtons.forEach(b => b.classList.remove('active'));
  const dashBtn = document.querySelector('.nav button[data-section="dashboard"]');
  if(dashBtn) dashBtn.classList.add('active');
  sections.forEach(s => s.style.display = 'none');
  const dashSection = document.getElementById('dashboard');
  if(dashSection) dashSection.style.display = 'block';
  updateUserBadgeUI();
}

function updateUserBadgeUI(){
  // update badge display if element exists
  if(!userBadge) return;
  if(data.currentUser){
    const u = data.authUsers.find(x => x.username === data.currentUser);
    const display = u ? (u.displayName || u.username) : data.currentUser;
    currentUserEl.textContent = display;
    userBadge.innerHTML = `<div class="badge">${(u && u.avatar) ? `<img src="${u.avatar}" alt="avatar" />` : `<span class="initials">${display.split(' ').map(n=>n[0]).slice(0,2).join('')}</span>`}</div>`;
  } else {
    currentUserEl.textContent = 'Guest';
    userBadge.innerHTML = `<div class="badge"><span class="initials">G</span></div>`;
  }
}

// doLogin handler
if (doLogin) doLogin.addEventListener('click', ()=>{
  const u = loginUserInput.value.trim();
  const p = loginPassInput.value;
  if(!u || !p){ showNotification('Login va parol kiriting', 'warning'); return; }
  if(!canAttemptLogin(u)){ showNotification('Ko\'p urinish! Keyinroq qayta urinib ko\'ring (5 daqiqa)', 'error'); return; }
  const auth = data.authUsers.find(x => x.username === u && x.password === p);
  if(auth){
    resetAttempts(u);
    setCurrentUser(u);
    if(modalLogin) modalLogin.classList.remove('open');
    // update current user display to human-friendly name
    currentUserEl.textContent = auth.displayName || auth.username;
  } else {
    recordFailedAttempt(u);
    const remaining = Math.max(0, 3 - (data.loginAttempts[u]?.count || 0));
    showNotification(`Login yoki parol xato. Qolgan urinishlar: ${remaining}`, 'error');
  }
});

// logout from menu
const doLogoutMenu = document.getElementById('doLogoutMenu');
if(doLogoutMenu) doLogoutMenu.addEventListener('click', () => {
  data.currentUser = null; 
  localStorage.removeItem('admin_demo_session');
  currentUserEl.textContent = 'Guest'; 
  profileMenu.classList.remove('open');
  showNotification('Tizimdan chiqildi', 'info');
  navButtons.forEach(b => b.classList.remove('active'));
  const dashBtn = document.querySelector('.nav button[data-section="dashboard"]');
  if(dashBtn) dashBtn.classList.add('active');
  sections.forEach(s => s.style.display = 'none');
  const dashSection = document.getElementById('dashboard');
  if(dashSection) dashSection.style.display = 'block';
  updateUserBadgeUI();
});

/* --- Quick profile & settings handlers --- */
const profileBtn = document.getElementById('profileBtn');
if(profileBtn) profileBtn.addEventListener('click', () => {
  navButtons.forEach(b => b.classList.remove('active'));
  const btn = document.querySelector('.nav button[data-section="profile"]');
  if(btn) btn.classList.add('active');
  sections.forEach(s => s.style.display = 'none');
  const profileSection = document.getElementById('profile');
  if(profileSection) profileSection.style.display = 'block';
  profileMenu.classList.remove('open');
});
const settingsBtn = document.getElementById('settingsBtn');
if(settingsBtn) settingsBtn.addEventListener('click', () => {
  navButtons.forEach(b => b.classList.remove('active'));
  const btn = document.querySelector('.nav button[data-section="settings"]');
  if(btn) btn.classList.add('active');
  sections.forEach(s => s.style.display = 'none');
  const settingsSection = document.getElementById('settings');
  if(settingsSection) settingsSection.style.display = 'block';
  profileMenu.classList.remove('open');
});

/* --- Profile save --- */
if(document.getElementById('saveProfile')) document.getElementById('saveProfile').addEventListener('click', () => {
  const name = document.getElementById('profileName').value.trim();
  const surname = document.getElementById('profileSurname').value.trim();
  const email = document.getElementById('profileEmail').value.trim();
  const phone = document.getElementById('profilePhone').value.trim();
  const password = document.getElementById('profilePassword').value;
  const passwordConfirm = document.getElementById('profilePasswordConfirm').value;
  if (!name || !surname || !email) { showNotification('Ism, familiya va email maydonlari to\'ldirilishi shart', 'warning'); return; }
  if (password && password !== passwordConfirm) { showNotification('Parollar mos kelmadi', 'error'); return; }
  showNotification('Profil ma\'lumotlari saqlandi', 'success');
  document.getElementById('profilePassword').value = '';
  document.getElementById('profilePasswordConfirm').value = '';
});

/* --- Settings management --- */
if(document.getElementById('saveSettings')) document.getElementById('saveSettings').addEventListener('click', () => {
  data.settings.language = document.getElementById('systemLanguage').value;
  data.settings.timeFormat = document.getElementById('timeFormat').value;
  data.settings.notifications = document.getElementById('notifications').value;
  data.settings.autoSave = document.getElementById('autoSave').value;
  showNotification('Sozlamalar saqlandi', 'success');
  setupAutoSave();
});

/* --- Export/Import functionality --- */
if(document.getElementById('exportData')) document.getElementById('exportData').addEventListener('click', () => {
  if (!data.currentUser) {
    showNotification('Bu amalni bajarish uchun tizimga kiring', 'warning');
    document.getElementById('modalLogin').classList.add('open');
    return;
  }
  const dataStr = JSON.stringify(data, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `admin-data-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  showNotification('Ma\'lumotlar yuklab olindi', 'success');
});

if(document.getElementById('importData')) document.getElementById('importData').addEventListener('click', () => {
  if (!data.currentUser) {
    showNotification('Bu amalni bajarish uchun tizimga kiring', 'warning');
    document.getElementById('modalLogin').classList.add('open');
    return;
  }
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = event => {
      try {
        const importedData = JSON.parse(event.target.result);
        if (importedData.schools) data.schools = importedData.schools;
        if (importedData.users) data.users = importedData.users;
        if (importedData.roles) data.roles = importedData.roles;
        if (importedData.plans) data.plans = importedData.plans;
        renderStaff(); renderStudents(); renderSchools(); renderRoles(); renderPlans(); refreshStats();
        showNotification('Ma\'lumotlar muvaffaqiyatli yuklandi', 'success');
      } catch (err) {
        showNotification('Faylni o\'qishda xatolik', 'error');
      }
    };
    reader.readAsText(file);
  };
  input.click();
});

/* --- Keyboard Esc to close modals --- */
document.addEventListener('keydown',(e)=>{ 
  if(e.key==='Escape'){ document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open')); } 
});

/* --- Auto-save --- */
let autoSaveInterval;
function setupAutoSave() {
  if (autoSaveInterval) clearInterval(autoSaveInterval);
  const interval = parseInt(data.settings.autoSave) * 1000;
  if (interval > 0) {
    autoSaveInterval = setInterval(() => {
      localStorage.setItem('admin_demo', JSON.stringify(data));
    }, interval);
  }
}
setupAutoSave();

/* --- Load from storage if exists --- */
try{
  const saved = JSON.parse(localStorage.getItem('admin_demo')||'null');
  if(saved){
    if(saved.schools) data.schools = saved.schools;
    if(saved.users) data.users = saved.users;
    if(saved.roles) data.roles = saved.roles;
    if(saved.plans) data.plans = saved.plans;
    if(saved.settings) data.settings = saved.settings;
    if(saved.currentUser) data.currentUser = saved.currentUser;
    renderStaff(); renderStudents(); renderSchools(); renderRoles(); renderPlans(); refreshStats();
    loadSettings();
    setupAutoSave();
    if (data.currentUser) { currentUserEl.textContent = data.currentUser; updateUserBadgeUI(); }
  }
  // restore session (short)
  const sess = JSON.parse(localStorage.getItem('admin_demo_session')||'null');
  if(sess && sess.user){
    data.currentUser = sess.user;
    updateUserBadgeUI();
  }
}catch(e){ /* ignore */ }

/* --- End of script --- */
</script>

</body>
</html>